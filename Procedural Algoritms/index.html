<style>
    body { background-color: #222 }
</style>
<script src="phaser3/3.18.1.js"></script>
<script type="module" src="phaser3/index.js"></script>
<script type="module">

    const mapWidth = 180;
    const mapHeight = 80;
    // const p1 = 3;
    // const p2 = 4;
    const tileSetSize = 48;
    const mapZoom = 1 // 0.5;
    
    import sampleData from './game_of_life/plugins/dataSample.js';
    import Utils from './game_of_life/plugins/utils.js';
    const {convertArrayToLayer, convertLayerToTilemap, FilterBucket} = Utils;


    // import generateMap from './controllers/golController.js'
    // const GoLmap = generateMap(mapWidth, mapHeight, undefined, p1, p2);

    
    const GoLmap = convertArrayToLayer(mapWidth, mapHeight, sampleData);

    const sameCellBucket = new FilterBucket(GoLmap, (a, b) => a.state.valueConverted === b.state.valueConverted);

    const clusters = [];
    GoLmap.cellIterator(cell => {
        if (cell.state.valueConverted === 6) {
            return
        }

        cell.state.valueConverted = 113

        clusters.push( sameCellBucket.getStaticClusterOf(cell.x, cell.y) )
    });


    const tilemapCornerMap = {
        "ExceptRight": 99,
        "ExceptTop": 98,
        "TopLeft": 115,
        "OnlyLeft": 81,
        "Vertical": 118,
        "OnlyRight": 78,
        "BottomRight": 96,
        "ExceptBottom": 117,
        "BottomLeft": 97,
        "OnlyBottom": 82,
        "OnlyUp": 136,
        "ExceptLeft": 116
    };

    function drawCluster(cluster, cornerMap) {
        const normalVectorsOfFirstCluster = []
        cluster.frontierCells.forEach((cell, i) => {
            normalVectorsOfFirstCluster.push(cluster.getNormalVectorOfFrontierCell(i))
        });

        normalVectorsOfFirstCluster.forEach((normalVector, index) => {
            const {cell} = cluster.frontierCells[index]
            const {x, y} = cell
            const value = cornerMap[normalVector] || 113
            GoLmap.setCell(x, y, [{name: "valueConverted", value}])
        });
    }

    clusters.forEach(cluster => drawCluster(cluster, tilemapCornerMap));


 
    import mapTemplate from './controllers/mapController.js';


    const map = mapTemplate('mapId', 
                            // "https://miro.medium.com/max/1400/1*to2RUPNgu4VM8PPSLeOHHA.png"
                            './borders-tileset-extruded.png', 
                            tileSetSize, tileSetSize, 
                            mapZoom, 
                            convertLayerToTilemap(GoLmap, cell => cell.state.valueConverted));


    //
    class CustomScene extends Phaser.Scene {
        constructor(...args) {
            super(...args)
        }

        static key = "GoL-View"

        preload() {
            map.preload(this);
        }

        create() {

            this.map = map.create(this, undefined, undefined, {
                "6": { "collide": true }
            });
            


            this.keyboardControls = Game.controller(this);
            const controlConfig = {
                camera: this.cameras.main,
                left: this.keyboardControls.left,
                right: this.keyboardControls.right,
                up: this.keyboardControls.up,
                down: this.keyboardControls.down,
                speed: 0.5,
                zoomIn: this.keyboardControls.primary,
                zoomOut: this.keyboardControls.secondary,
            };
            this.controls = new Phaser.Cameras.Controls.FixedKeyControl(controlConfig);


            // const tile = this.map.getTileAt(2, 2, false);
            // const {index, tilemapLayer} = tile;
            // console.log(index, tilemapLayer.properties);
        }

        update(time, delta) {
            this.controls.update(delta);
        }
    }

    Game.addScene(CustomScene, true);


</script>